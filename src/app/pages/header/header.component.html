<header class="sticky top-0 w-full shadow-md bg-white z-50">
  <div class="mx-auto flex items-center justify-between h-20 px-4 sm:px-6 md:px-12 lg:px-16">
    <!-- Logo -->
    <div class="flex items-center">
      <div class="relative w-28 h-14">
        <div class="absolute w-full h-full bg-[#5371ff] rounded-xl"></div>
        <div class="relative w-full h-14 left-2 border-[3px] border-[#5371ff] rounded-xl"></div>
        <img class="absolute w-20 top-0 left-4 object-contain" src="/assets/logo.png" alt="Yakalma Logo" />
      </div>
    </div>

    <!-- Desktop Navigation -->
    <nav class="hidden mt-4 lg:block">
      <ul class="flex gap-6">
        <li *ngFor="let item of navItems" class="group relative"
        routerLinkActive="active-link"
        [routerLinkActiveOptions]="{ exact: true }"
        >
          <a
            [routerLink]="item.href"
            class="font-oswald text-base font-medium !text-[#212121] relative !no-underline transition-colors duration-300 ease-in-out group-hover:!text-[#5371ff]"
          >
            {{ item.label }}
            <!-- Ligne animée sous le lien -->
            <span
              class="absolute left-0 -bottom-1 h-0.5 bg-[#5371ff] transition-all duration-300 w-0 group-hover:w-full group-[.active-link]:w-full"
            ></span>
          </a>
        </li>
      </ul>
    </nav>

    <!-- Right Side -->
    <div class="flex items-center gap-5">
      <!-- Search -->
      <div class="relative hidden sm:flex items-center gap-2">
        <input type="text" placeholder="Rechercher une adresse..." [(ngModel)]="searchTerm" (input)="onSearchChange()" class="px-4 py-2 rounded-lg border border-gray-300 text-sm w-56 focus:outline-none focus:ring-2 focus:ring-[#5371ff]" />
        <button class="text-[#5371ff] hover:text-[#425ac7] transition" aria-label="Rechercher"><i class="fas fa-search"></i></button>

        <!-- Dropdown résultats -->
        <div *ngIf="searchTerm && filteredRestaurants.length > 0" class="absolute top-full left-0 bg-white border border-gray-300 w-72 max-h-56 overflow-y-auto rounded-md shadow-lg mt-2 z-50">
          <ul>
            <li *ngFor="let restaurant of filteredRestaurants" class="px-4 py-2 cursor-pointer hover:bg-[#e0e7ff]" (click)="goToRestaurantMenu(restaurant._id)" tabindex="0" (keydown.enter)="goToRestaurantMenu(restaurant._id)">
              <strong>{{ restaurant.name }}</strong><br />
              <small class="text-gray-600">{{ restaurant.address }}</small>
            </li>
          </ul>
        </div>
        <div *ngIf="searchTerm && filteredRestaurants.length === 0" class="absolute top-full left-0 bg-white border border-gray-300 w-72 p-3 rounded-md shadow-md mt-2 z-50 text-gray-600">
          Aucun restaurant trouvé
        </div>
      </div>

      <!-- Mini Panier -->
      <div class="relative" (click)="toggleCartDropdown()" tabindex="0" (keydown.enter)="toggleCartDropdown()">
        <fa-icon [icon]="faShoppingCart" size="lg" class="text-[#5371ff] cursor-pointer"></fa-icon>
        <span *ngIf="cartCount > 0" class="absolute -top-2 -right-2 bg-red-600 text-white text-xs font-semibold rounded-full px-1.5 py-0.5 select-none">{{ cartCount }}</span>

        <div *ngIf="showCartDropdown" class="absolute right-0 mt-3 w-80 bg-white border border-gray-300 rounded-lg shadow-lg z-50 p-4 animate-fadeIn" (click)="$event.stopPropagation()">
          <h3 class="text-lg font-semibold mb-4 border-b border-gray-200 pb-2">Panier ({{ cartCount }})</h3>

          <div *ngIf="cartItems.length > 0; else emptyCartTemplate">
            <ul class="max-h-48 overflow-auto mb-4 divide-y divide-gray-200">
              <li *ngFor="let item of cartItems" class="py-2 flex items-center gap-3">
                <img [src]="item.image" alt="plat" class="w-14 h-14 object-cover rounded-lg shadow-sm" />
                <div class="flex-1">
                  <p class="text-sm font-semibold truncate">{{ item.name }}</p>
                  <p class="text-xs text-gray-500 truncate">{{ item.restaurantName }}</p>
                  <p class="text-xs text-gray-600">Quantité: {{ item.quantity }}</p>
                  <ng-container *ngIf="item.supplements && item.supplements.length > 0">
                    <p class="text-xs text-gray-500 mt-1">
                      Suppléments :
                      <span *ngFor="let sup of item.supplements; let last = last">
                        {{ sup.name }}<span *ngIf="sup.price"> (+{{ sup.price | currency:'XOF' }})</span><span *ngIf="!last">, </span>
                      </span>
                    </p>
                  </ng-container>
                </div>
                <p class="text-sm font-bold text-[#5371ff]">{{ item.total ? (item.total | currency : 'XOF') : ((item.price * item.quantity) | currency : 'XOF') }}</p>
              </li>
            </ul>

            <!-- Total du panier -->
            <div class="flex justify-between items-center mb-4">
              <span class="font-semibold text-gray-700">Total :</span>
              <span class="font-bold text-lg text-[#5371ff]">{{ getCartTotal() | currency : 'XOF' }}</span>
            </div>

            <button (click)="emptyCart()" class="w-full bg-red-600 hover:bg-red-700 text-white py-2 rounded-md font-semibold transition">Vider le panier</button>
            <button (click)="payCart()" class="w-full mt-3 bg-green-600 hover:bg-green-700 text-white py-2 rounded-md font-semibold transition">Payer le panier</button>
          </div>

          <ng-template #emptyCartTemplate>
            <p class="text-center text-gray-500 py-6">Votre panier est vide.</p>
          </ng-template>
        </div>
      </div>

      <!-- Connexion -->
      <button class="hidden sm:inline-block bg-[#ffc222] hover:bg-[#e6ae1f] text-white text-sm font-semibold py-2 px-5 rounded-lg shadow-md transition" (click)="onLoginClick()">Connexion</button>

      <!-- Burger menu -->
      <div class="lg:hidden text-3xl cursor-pointer text-[#5371ff]" (click)="toggleMenu()" aria-label="Menu mobile" tabindex="0" (keydown.enter)="toggleMenu()">
        <fa-icon [icon]="isMenuOpen ? faTimes : faBars"></fa-icon>
      </div>
    </div>
  </div>

  <!-- Menu mobile -->
  <div class="lg:hidden fixed inset-0 z-30" [class.pointer-events-none]="!isMenuOpen" [class.pointer-events-auto]="isMenuOpen">
    <div class="absolute inset-0 bg-black transition-opacity duration-300" [class.opacity-0]="!isMenuOpen" [class.opacity-50]="isMenuOpen" (click)="closeMenu()"></div>
    <div class="absolute top-0 left-0 h-full w-4/5 max-w-xs bg-white shadow-lg p-6 transform transition-transform duration-300 overflow-y-auto" [class.-translate-x-full]="!isMenuOpen" [class.translate-x-0]="isMenuOpen" (click)="$event.stopPropagation()">
      <ul class="flex flex-col gap-6 text-[#212121] font-oswald text-lg font-semibold mb-8">
        <li *ngFor="let item of navItems">
          <a [routerLink]="item.href" (click)="navigateAndClose(item.href)" class="hover:text-[#5371ff]" tabindex="0" (keydown.enter)="navigateAndClose(item.href)">{{ item.label }}</a>
        </li>
      </ul>

      <input type="text" placeholder="Rechercher une adresse..." [(ngModel)]="searchTerm" (input)="onSearchChange()" class="w-full px-4 py-2 border border-gray-300 rounded-md text-base focus:outline-none focus:ring-2 focus:ring-[#5371ff]" />
      <button class="mt-6 w-full py-3 bg-[#ffc222] hover:bg-[#e6ae1f] text-white font-semibold rounded-lg shadow-md transition" (click)="onLoginClick()">Connexion</button>
    </div>
  </div>

  <!-- Modal de commande -->
  <div *ngIf="showOrderModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-md">
      <div class="p-6">
        <h2 class="text-xl font-bold mb-4">Finaliser votre commande</h2>

        <!-- Choix de l'opérateur -->
        <div *ngIf="showOperatorChoice">
          <p class="text-gray-600 mb-4">Choisissez votre méthode de paiement :</p>
          <div class="grid grid-cols-2 gap-3 mb-6">
            <div *ngFor="let op of operators"
                 class="border border-gray-300 rounded-lg p-3 cursor-pointer hover:border-[#5371ff] transition-colors"
                 [class.border-[#5371ff]]="selectedOperator === op"
                 (click)="chooseOperator(op)">
              <img [src]="op.image" [alt]="op.name" class="h-8 mx-auto mb-2">
              <p class="text-sm text-center">{{ op.name }}</p>
            </div>
          </div>
          <button (click)="closeOrderModal()" class="w-full bg-gray-300 hover:bg-gray-400 text-gray-800 py-2 rounded-md font-semibold transition">Annuler</button>
        </div>

        <!-- Formulaire de paiement -->
        <div *ngIf="showPaymentForm">
          <form (ngSubmit)="processCartPayment()" class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Nom complet</label>
              <input type="text" [(ngModel)]="payment.name" name="name" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-[#5371ff]">
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Numéro de téléphone</label>
              <input type="tel" [(ngModel)]="payment.contact" name="contact" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-[#5371ff]">
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Adresse de livraison</label>
              <textarea [(ngModel)]="payment.address" name="address" required rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-[#5371ff]"></textarea>
            </div>

            <div class="flex gap-3">
              <button type="button" (click)="closeOrderModal()" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 py-2 rounded-md font-semibold transition">Annuler</button>
              <button type="submit" class="flex-1 bg-green-600 hover:bg-green-700 text-white py-2 rounded-md font-semibold transition">Payer maintenant</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Messages -->
  <div *ngIf="successMessage" class="fixed top-4 right-4 bg-green-500 text-white px-4 py-2 rounded shadow-lg z-50">{{ successMessage }}</div>
  <div *ngIf="errorMessage" class="fixed top-4 right-4 bg-red-500 text-white px-4 py-2 rounded shadow-lg z-50">{{ errorMessage }}</div>
  <div *ngIf="infoMessage" class="fixed top-4 right-4 bg-blue-500 text-white px-4 py-2 rounded shadow-lg z-50">{{ infoMessage }}</div>
</header>
