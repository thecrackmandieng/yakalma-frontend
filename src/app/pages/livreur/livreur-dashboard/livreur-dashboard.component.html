<app-header-livreur></app-header-livreur>

<div class="container mx-auto p-4">
  <h1 class="text-2xl font-bold mb-6">Liste des Commandes Livrées</h1>

  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
    <div class="bg-white rounded-xl shadow p-4 flex flex-col" *ngFor="let order of orders">

      <!-- Image + Actions -->
      <div class="relative mb-4">
        <img [src]="order.image" alt="Image commande" class="w-full h-48 object-cover rounded-lg" [class.opacity-50]="order.status === 'en_cours'">

        <div class="absolute top-2 right-2 flex space-x-2">
          <button *ngIf="order.status === 'livre'" (click)="acceptOrder(order)"
                  class="bg-green-500 text-white px-3 py-1 rounded hover:bg-green-600">
            Accepter
          </button>
          <button (click)="showMap(order)" [disabled]="order.status === 'en_cours'"
                  class="bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600 disabled:opacity-50 disabled:cursor-not-allowed">
            <i class="fas fa-location-dot"></i>
          </button>
        </div>
      </div>

      <!-- Détails -->
      <div class="text-gray-700 flex-1">
        <h2 class="font-semibold mb-1">Commande #{{ order._id?.slice(0, 6) }}...</h2>
        <p><strong>Client:</strong> {{ order.customerName }}</p>
        <p><strong>Adresse:</strong> {{ order.address }}</p>
        <p><strong>Contact:</strong> {{ order.contact }}</p>

        <p><strong>Restaurant:</strong> {{ order.restaurantName || 'N/A' }}</p>
        <p><strong>Téléphone restaurant:</strong> {{ order.restaurantPhone || 'N/A' }}</p>
        <p><strong>Adresse restaurant:</strong> {{ order.restaurantAddress || 'N/A' }}</p>

        <p><strong>Statut:</strong> {{ order.status }}</p>

        <p class="mt-2 font-semibold">Articles:</p>
        <ul class="list-disc list-inside">
          <li *ngFor="let item of order.items">
            {{ item.name }} – {{ item.quantity }}
          </li>
        </ul>
      </div>

    </div>
  </div>
</div>

<!-- Modal Navigation -->
<div *ngIf="selectedOrder" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" (click)="closeModal()">
  <div class="bg-white rounded-xl w-11/12 md:w-3/4 lg:w-2/3 max-w-5xl p-4 relative"
       (click)="$event.stopPropagation()">

    <!-- Header -->
    <div class="flex justify-between items-center mb-4">
      <h3 class="text-xl font-bold">Navigation vers le client</h3>
      <button (click)="closeModal()" class="text-gray-600 hover:text-gray-800 text-2xl">&times;</button>
    </div>

    <!-- Infos route -->
    <div *ngIf="selectedOrder.routeInfo" class="flex flex-wrap space-x-6 mb-4 text-gray-700">
      <div class="flex items-center space-x-2">
        <i class="fas fa-route"></i>
        <span>Distance: {{ selectedOrder.routeInfo.distance }}</span>
      </div>
      <div class="flex items-center space-x-2">
        <i class="fas fa-clock"></i>
        <span>Temps estimé: {{ selectedOrder.routeInfo.duration }}</span>
      </div>
    </div>

    <!-- Carte -->
    <div id="map-container" class="h-[600px] md:h-[700px] w-full border border-gray-300 rounded-lg mb-4">
      <div *ngIf="!map" class="flex items-center justify-center h-full text-gray-500">
        <i class="fas fa-map-marked-alt text-2xl mr-2"></i>
        <span>Carte de navigation</span>
      </div>
    </div>

    <!-- Actions -->
    <div class="flex justify-end space-x-2">
      <button (click)="startNavigation()"
              class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600 flex items-center space-x-2">
        <i class="fas fa-play"></i>
        <span>Démarrer la navigation</span>
      </button>
      <button (click)="closeModal()"
              class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600 flex items-center space-x-2">
        <i class="fas fa-times"></i>
        <span>Fermer</span>
      </button>
    </div>

    <!-- Loading / Erreur -->
    <div *ngIf="isLoadingLocation" class="flex items-center space-x-2 mt-3 text-gray-700">
      <i class="fas fa-spinner fa-spin"></i>
      <span>Chargement de votre position...</span>
    </div>

    <div *ngIf="locationError" class="flex items-center space-x-2 mt-3 text-red-600">
      <i class="fas fa-exclamation-triangle"></i>
      <span>{{ locationError }}</span>
    </div>

  </div>
</div>

<app-footer></app-footer>
